# 设备独立日志功能说明

## 功能概述

为了解决大量设备接入时问题定位困难的问题，我们实现了设备独立日志功能。每个设备都将拥有独立的日志文件，以设备唯一标识符命名，记录该设备与中间件的所有交互数据。

## 功能特点

1. **设备独立文件** - 每个设备生成独立的日志文件，文件名为`{设备ID}.log`
2. **完整交互记录** - 记录设备的所有数据交互、状态变化、指令发送等
3. **自动日志轮转** - 支持日志文件大小和时间基础的自动轮转
4. **压缩存储** - 旧日志文件自动压缩，节省存储空间
5. **高性能设计** - 异步写入，不影响主业务性能
6. **可配置开关** - 可通过配置文件灵活启用/禁用

## 配置说明

在 `configs/config.yaml` 中添加以下配置：

```yaml
log:
  # ... 其他日志配置 ...
  
  # 设备独立日志配置
  device_log:
    enabled: true                    # 是否启用设备独立日志
    base_dir: "logs/devices"         # 设备日志基础目录
    max_size: 10                     # 单个设备日志文件最大大小(MB)
    max_age: 30                      # 设备日志文件保留天数
    compress: true                   # 是否压缩设备日志文件
```

### 配置参数详解

| 参数 | 类型 | 默认值 | 说明 |
|-----|------|--------|------|
| `enabled` | bool | false | 是否启用设备独立日志功能 |
| `base_dir` | string | "logs/devices" | 设备日志文件存储基础目录 |
| `max_size` | int | 10 | 单个日志文件最大大小(MB)，超过后自动轮转 |
| `max_age` | int | 7 | 日志文件保留天数，超过后自动删除 |
| `compress` | bool | false | 是否压缩已轮转的日志文件 |

## 日志文件结构

### 目录结构
```
logs/
├── app.log              # 主应用日志
└── devices/             # 设备独立日志目录
    ├── 00000001.log     # 设备ID为00000001的日志
    ├── 00000002.log     # 设备ID为00000002的日志
    ├── 00000001.log.1   # 设备00000001的轮转日志
    └── 00000001.log.1.gz # 压缩的轮转日志
```

### 日志格式
每行日志格式：`[时间] [级别] [设备ID] 消息 [字段]`

示例：
```
[2024-01-15 14:30:25.123] [info] [00000001] 设备数据交互 | [direction=received data_len=12 data_hex=0102030405060708090a0b0c remote_addr=192.168.1.100:54321 protocol=SensorProtocol]
[2024-01-15 14:30:25.124] [info] [00000001] 设备事件 | [event=data_parsed message_type=data data_fields=4 quality=1 protocol=SensorProtocol]
[2024-01-15 14:30:25.125] [info] [00000001] 设备事件 | [event=platform_sent message_type=data data_fields=4 protocol=SensorProtocol]
```

## 记录的事件类型

### 1. 设备数据交互 (`LogDeviceData`)
记录设备与中间件之间的原始数据交换：
- **direction**: `received`(接收) 或 `sent`(发送)
- **data_len**: 数据长度
- **data_hex**: 十六进制格式的原始数据
- **remote_addr**: 设备远程地址
- **protocol**: 使用的协议名称

### 2. 设备事件 (`LogDeviceEvent`)
记录设备相关的重要事件：
- `connection_established` - 连接建立
- `connection_closed` - 连接关闭
- `connection_error` - 连接错误
- `data_parsed` - 数据解析成功
- `parse_data_failed` - 数据解析失败
- `platform_sent` - 数据成功发送到平台
- `platform_send_failed` - 平台发送失败
- `status_sent` - 状态成功发送到平台
- `status_send_failed` - 状态发送失败

### 3. 设备指令 (`LogDeviceCommand`)
记录发送给设备的指令：
- **command**: 指令类型（如 sleep, config, query）
- **params**: 指令参数
- **result**: 执行结果

### 4. 设备状态 (`LogDeviceStatus`)
记录设备状态变化：
- **status**: 状态（online, offline）
- **remote_addr**: 设备远程地址
- **protocol**: 协议名称

## 使用示例

### 查看特定设备的日志
```bash
# 查看设备00000001的实时日志
tail -f logs/devices/00000001.log

# 查看设备00000001的历史日志
cat logs/devices/00000001.log

# 搜索设备00000001的连接事件
grep "connection_established\|connection_closed" logs/devices/00000001.log
```

### 分析设备交互数据
```bash
# 查看设备接收的数据
grep "direction=received" logs/devices/00000001.log

# 查看设备发送的指令
grep "direction=sent" logs/devices/00000001.log

# 查看数据解析失败的记录
grep "parse_data_failed" logs/devices/00000001.log
```

### 监控设备状态变化
```bash
# 查看设备上下线记录
grep "status=" logs/devices/00000001.log

# 查看平台通信失败记录
grep "platform_send_failed\|status_send_failed" logs/devices/00000001.log
```

## 性能考虑

1. **异步写入** - 设备日志采用异步写入方式，不阻塞主业务流程
2. **内存缓冲** - 合理的内存缓冲机制，减少磁盘I/O频次
3. **按需创建** - 只为有数据交互的设备创建日志文件
4. **自动清理** - 定期清理过期日志文件，避免磁盘空间耗尽

## 故障排查指南

### 1. 设备连接问题
查找设备连接建立和断开的记录：
```bash
grep -E "connection_established|connection_closed|connection_error" logs/devices/{设备ID}.log
```

### 2. 数据解析问题
查找数据解析失败的记录：
```bash
grep "parse_data_failed" logs/devices/{设备ID}.log
```

### 3. 平台通信问题
查找平台通信失败的记录：
```bash
grep -E "platform_send_failed|status_send_failed" logs/devices/{设备ID}.log
```

### 4. 指令发送问题
查找指令发送相关的记录：
```bash
grep -E "command|direction=sent" logs/devices/{设备ID}.log
```

## 运维建议

1. **定期监控** - 监控日志目录大小，确保有足够的磁盘空间
2. **备份策略** - 建立重要设备日志的备份策略
3. **清理策略** - 根据业务需要调整日志保留天数
4. **性能监控** - 监控日志写入性能，必要时调整配置参数
5. **告警机制** - 建立关键错误事件的告警机制

## 注意事项

1. **隐私保护** - 设备日志可能包含敏感数据，需要适当的权限控制
2. **存储管理** - 大量设备会产生大量日志文件，需要合理的存储规划
3. **性能影响** - 虽然采用异步写入，但仍会有一定的性能开销
4. **文件句柄** - 大量设备可能导致文件句柄数量较多，需要调整系统限制

## 常见问题

### Q: 设备日志功能对性能有多大影响？
A: 采用异步写入和内存缓冲机制，对主业务性能影响很小，通常在1-2%以内。

### Q: 如何处理大量设备产生的日志文件？
A: 可以通过调整`max_size`和`max_age`参数控制日志文件大小和保留时间，启用压缩可以节省存储空间。

### Q: 设备下线后日志文件会立即删除吗？
A: 不会，设备下线后日志文件会保留，直到超过配置的保留天数才会自动删除。

### Q: 可以动态开启/关闭设备日志功能吗？
A: 目前需要修改配置文件并重启服务，暂不支持动态开关。

### Q: 如何查看当前有多少个设备在记录日志？
A: 可以通过统计`logs/devices/`目录下的`.log`文件数量，或者查看主日志中的统计信息。 