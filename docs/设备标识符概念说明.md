# 设备标识符概念说明

## 重要概念区分

在本协议插件框架中，我们严格区分两个不同的设备标识符概念：

### 1. 设备编号 (device_number)
- **定义**: 设备本身的唯一标识符，从设备数据包中提取
- **来源**: 设备硬件或固件中固化的标识符
- **用途**: 协议层面的设备识别，用于建立设备与平台的映射关系
- **示例**: `"00000001"`, `"ABC123456"`, `"SENSOR_001"`

### 2. 设备ID (device_id) 
- **定义**: 平台分配给设备的内部ID
- **来源**: ThingsPanel平台在设备注册时生成的唯一标识符
- **用途**: 平台内部数据管理和API调用
- **示例**: `"550e8400-e29b-41d4-a716-446655440000"`

## 数据流程

```
1. 设备发送数据包
   ↓
2. 协议层提取设备编号 (device_number)
   ↓  
3. 框架通过设备编号查询平台获取设备ID (device_id)
   ↓
4. 使用设备ID向平台发送数据
```

## 开发者需要关注的部分

### ✅ 你需要实现
- `ExtractDeviceNumber()` - 从数据包中提取设备编号
- `ParseData()` - 解析数据并设置 `DeviceNumber` 字段
- `EncodeCommand()` - 使用 `cmd.DeviceNumber` 构建指令

### ❌ 你无需关注
- 设备ID的获取（框架自动处理）
- 设备编号到设备ID的映射（框架自动处理）
- 平台API调用（框架自动处理）

## 代码示例

### 正确的数据解析实现
```go
func (h *YourProtocolHandler) ParseData(data []byte) (*protocol.Message, error) {
    // 提取设备编号
    deviceNumber, err := h.ExtractDeviceNumber(data)
    if err != nil {
        return nil, err
    }
    
    // 解析传感器数据
    sensorData := map[string]interface{}{
        "temperature": extractTemperature(data),
        "humidity":    extractHumidity(data),
    }
    
    return &protocol.Message{
        DeviceNumber: deviceNumber, // ✅ 设备编号（从设备提取）
        DeviceID:     "",          // ✅ 设备ID（框架自动填充）
        MessageType:  "data",
        Timestamp:    time.Now(),
        Data:         sensorData,
        Quality:      1,
    }, nil
}
```

### 正确的指令编码实现
```go
func (h *YourProtocolHandler) EncodeCommand(cmd *protocol.Command) ([]byte, error) {
    switch cmd.Action {
    case "config":
        // ✅ 使用设备编号构建指令
        return h.buildConfigCommand(cmd.DeviceNumber, cmd.Parameters)
    default:
        return nil, fmt.Errorf("不支持的指令: %s", cmd.Action)
    }
}
```

## 设备日志系统

设备独立日志系统使用**设备编号**作为日志文件名：

```
logs/devices/
├── 00000001.log     # 设备编号为00000001的日志
├── 00000002.log     # 设备编号为00000002的日志
└── ABC123456.log    # 设备编号为ABC123456的日志
```

### 日志记录函数
```go
// ✅ 正确：使用设备编号
logger.LogDeviceData("00000001", "received", data, extraInfo)
logger.LogDeviceEvent("00000001", "connection_established", details)
logger.LogDeviceCommand("00000001", "config", params, result)
logger.LogDeviceStatus("00000001", "online", details)
```

## 常见错误

### ❌ 错误用法
```go
// 错误：混淆设备编号和设备ID
func (h *Handler) ParseData(data []byte) (*protocol.Message, error) {
    deviceID := extractSomeID(data) // 这里提取的其实是设备编号
    return &protocol.Message{
        DeviceID: deviceID,     // ❌ 错误：这里应该是DeviceNumber
        DeviceNumber: "",       // ❌ 错误：设备编号不能为空
        // ...
    }
}
```

### ✅ 正确用法
```go
// 正确：明确区分概念
func (h *Handler) ParseData(data []byte) (*protocol.Message, error) {
    deviceNumber := h.ExtractDeviceNumber(data) // 提取设备编号
    return &protocol.Message{
        DeviceNumber: deviceNumber, // ✅ 正确：设备编号
        DeviceID:     "",          // ✅ 正确：框架自动填充
        // ...
    }
}
```

## 框架自动处理的部分

1. **设备上线流程**
   - 提取设备编号 → 查询平台获取设备ID → 发送上线状态

2. **数据发送流程**  
   - 解析得到设备编号 → 查询平台获取设备ID → 发送遥测数据

3. **设备下线流程**
   - 连接断开 → 通过设备编号查询设备ID → 发送下线状态

4. **指令发送流程**
   - 接收指令请求 → 通过设备编号查找连接 → 编码并发送指令

## 总结

- **设备编号** - 设备的"身份证号"，固化在设备中，协议开发者需要提取
- **设备ID** - 平台的"档案编号"，平台内部管理使用，框架自动处理

遵循这个概念区分，可以避免开发过程中的混淆，确保设备能够正确上线和通信。 