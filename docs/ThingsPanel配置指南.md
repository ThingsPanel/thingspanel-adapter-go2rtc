# ThingsPanel 平台配置指南

## 一、服务配置（应用管理 → 接入协议 → 新增）

在ThingsPanel后台添加go2rtc适配器服务，填写以下信息：

| 配置项 | 填写内容 | 说明 |
|--------|---------|------|
| **服务名称** | `Go2RTC流媒体适配器` | 自定义名称，用于平台显示 |
| **服务标识符** | `OG-SZ501` | 必须与config.yaml中的`service_identifier`一致 |
| **类别** | `服务接入` | 选择"服务接入"类型 |
| **版本** | `1.0.0` | 插件版本号 |
| **描述** | `go2rtc流媒体服务器适配器，支持RTSP/RTMP等多种视频流协议接入` | 服务描述 |

---

## 二、插件配置（接入服务）

服务添加后，进入"插件配置"页面：

### 1. HTTP服务地址

**配置值**: `http://172.17.0.1:8081`

**说明**:
- 这是ThingsPanel平台调用插件的地址
- **如果平台运行在Docker容器内**，必须使用Docker网桥网关地址 `172.17.0.1`
- **如果平台直接运行在宿主机**，可使用 `http://127.0.0.1:8081`
- 端口号必须与 `config.yaml` 中的 `http_port` 一致

### 2. 设备类型

**配置值**: `直连设备`

**说明**: 
- 摄像头设备通过go2rtc直连，不需要网关
- 从下拉列表选择"直连设备"选项

### 3. 服务订阅主题前缀

**配置值**: (留空)

**说明**: 
- 此适配器不使用MQTT订阅主题前缀
- 可留空或填写 `plugin/OG-SZ501`

### 4. 设备接入地址

**配置值**: `http://10.147.17.226:8081`

**说明**:
- 这是设备或第三方系统访问适配器的地址
- 使用服务器的**公网IP**或**局域网IP**
- **不能使用** `127.0.0.1`，因为外部设备无法访问
- 示例：`http://10.147.17.226:8081`

---

## 三、服务接入点配置（三方接入）

在"应用管理 → 三方接入 → 新增服务接入点"中配置go2rtc连接信息：

| 配置项 | 填写内容 | 说明 |
|--------|---------|------|
| **服务接入点名称** | `本地go2rtc` | 自定义名称 |
| **服务类型** | `OG-SZ501` | 选择前面创建的服务 |
| **go2rtc API地址** | `http://localhost:1984` | go2rtc服务的API地址 |
| **同步间隔(秒)** | `30` | 设备同步间隔，建议30秒 |
| **启用自动同步** | `开启` | 启用后会自动同步go2rtc中的streams |

---

## 四、网络配置说明

### 场景1: ThingsPanel在Docker，插件在宿主机

```
┌─────────────────────────────────┐
│  ThingsPanel (Docker)           │
│  - 通过172.17.0.1访问插件        │
└─────────────────────────────────┘
         ↓ HTTP调用
┌─────────────────────────────────┐
│  宿主机 (10.147.17.226)         │
│  - 插件监听8081端口              │
│  - go2rtc监听1984端口            │
└─────────────────────────────────┘
         ↑ RTSP流
┌─────────────────────────────────┐
│  摄像头设备                      │
│  - 通过LAN访问go2rtc             │
└─────────────────────────────────┘
```

**配置要点**:
- HTTP服务地址: `http://172.17.0.1:8081`
- 设备接入地址: `http://10.147.17.226:8081`
- go2rtc API地址: `http://localhost:1984`

### 场景2: ThingsPanel和插件都在宿主机

**配置要点**:
- HTTP服务地址: `http://127.0.0.1:8081`
- 设备接入地址: `http://10.147.17.226:8081`
- go2rtc API地址: `http://localhost:1984`

---

## 五、验证配置

### 1. 检查服务在线状态

进入"应用管理 → 接入协议"，确认：
- 服务标识 `OG-SZ501` 显示为"在线"
- 绿色状态指示灯亮起

### 2. 检查设备同步

1. 在go2rtc中添加测试stream
2. 等待30秒（或配置的同步间隔）
3. 进入"应用管理 → 三方接入 → 查看设备列表"
4. 确认看到go2rtc的stream显示为设备

### 3. 查看日志

```bash
# 在服务器上检查适配器日志
tail -f ~/tp-adapter/app.log | grep -i "sync\|设备"
```

预期看到：
- `设备同步服务启动，间隔: 30s`
- `设备已同步: [stream_name]`
- `设备动态注册成功`

---

## 常见问题

### Q: 服务显示"离线"
**A**: 检查以下配置：
1. `config.yaml`中`service_identifier`是否与平台配置一致
2. MQTT连接是否正常（查看日志）
3. 心跳端点是否可访问

### Q: 设备列表中看不到go2rtc streams
**A**: 检查：
1. go2rtc是否运行（`curl http://localhost:1984/api/streams`）
2. 服务接入点中的API地址是否正确
3. 是否等待了足够的同步间隔时间
4. 查看适配器日志是否有错误

### Q: HTTP服务地址配置错误
**A**: 
- Docker环境必须使用 `172.17.0.1`
- 查看tp-memory开发笔记中的网络配置说明
- 测试: `curl http://172.17.0.1:8081/api/v1/form/config?form_type=SVCR&protocol_type=OG-SZ501&device_type=DIRECT`
